<!DOCTYPE html>
<html lang="en" ng-app>
<head>
  <meta charset="utf-8">
  <title>Travelling salesman - Genetic-js</title>
  <script src="random.js"></script>
  <script src="selection.js"></script>
  <script src="genetic.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.6/angular.min.js"></script>
</head>

<body id="home" ng-controller="SquareSumCtrl">

		<button ng-click="nextGeneration(10000)">Next generation</button>
		<button ng-click="start()">Start</button>

		<p>{{generationNumber}}</p>

		<table>
			<tr ng-repeat="individual in population">
				<td><strong>{{formatNumber(individual.fitness)}}</strong></td>
				<td ng-repeat="value in individual.genome">{{value}}</td>
			</tr>
		</table>

	<script type="text/javascript">

		function SquareSumCtrl($scope, $timeout)
		{

			cityNumber = 10;
			map = [];
			for (var i = 0; i < cityNumber; i++)
				map[i] = [randomDouble(0, 600), randomDouble(0, 400)];


			function myGenomeGenerator()
			{
				allValue = [];
				for (var i = 0; i < cityNumber; i++)
					allValue[i] = i;

		    var counter = allValue.length, temp, index;
		    while (--counter > -1) 
		    {
		        index = ~~(Math.random() * counter);
		        temp = allValue[counter];
		        allValue[counter] = allValue[index];
		        allValue[index] = temp;
		    }
		    return allValue;
			}

			function myMutationOperator(genome)
			{
				var rand = randomInteger(0, genome.length);
				var rand2 = randomIntegerWithout(0, genome.length, rand);
				temp = genome[rand];
				genome[rand] = genome[rand2];
				genome[rand2] = temp;
			}


			function myFitnessCalculator(genome)
			{
				var fitness = 0;
				for (var i = 0; i < genome.length - 1; i++)
				{
					var deltaX = map[genome[i]][0] - map[genome[i+1]][0];
					var deltaY = map[genome[i]][1] - map[genome[i+1]][1];
					fitness -= deltaX * deltaX + deltaY * deltaY;
				}
				return fitness;
			}


			function myReproductionOperator(fatherGenome, motherGenome)
			{
				var pivot = randomInteger(1, fatherGenome.length);
				var sonGenome = [];
				var daughterGenome = [];

				for (var i = 0; i < pivot; i++)
				{
					sonGenome[i] = fatherGenome[i];
					daughterGenome[i] = motherGenome[i];
				}

				for (i = pivot; i < fatherGenome.length; i++)
				{
					for (var j = 0; j < motherGenome.length; j++)
					{
						if (jQuery.inArray(motherGenome[j], sonGenome) === -1)
						{
							sonGenome[i] = motherGenome[j];
							break;
						}
					}

					for (var j = 0; j < fatherGenome.length; j++)
					{
						if (jQuery.inArray(fatherGenome[j], daughterGenome) === -1)
						{
							daughterGenome[i] = fatherGenome[j];
							break;
						}
					}
				}

				return [sonGenome, daughterGenome];
			}


			genetic.initialize({
				populationSize: 100,
				mutationProba: 0.2,
				disasterFrequency: 0,
				disasterGravity: 0.99,

				genomeGenerator: myGenomeGenerator,
				mutationOperator: myMutationOperator,
				reproductionOperator: myReproductionOperator,
				fitnessCalculator: myFitnessCalculator,

				finish: function(population) {
					console.log(population);
				}
			});



			

			$scope.population = genetic.getPopulation().slice(0, 20);
			$scope.generationNumber = genetic.getGenerationNumber();

			$scope.nextGeneration = function(nb) {
				for (var i = 0; i < nb; i++)
				{
					genetic.nextGeneration();
					$scope.population = genetic.getPopulation().slice(0, 20);
					$scope.generationNumber = genetic.getGenerationNumber();
				}
			};

			$scope.start = function() {
				$scope.nextGeneration(1000);
				$timeout($scope.start, 1);
			};

			$scope.formatNumber = function(number) {
				return number.toFixed(2);
			};
		}
	</script>

</body>
</html>